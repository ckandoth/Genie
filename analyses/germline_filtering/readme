GOAL: With the data provided from each institute, remove as many germline and FP sites as possible

::TODO::
- Read counts and other metrics across likely somatic sites, but that we tagged as common_variant.
- Plot read counts of FPs across centers, and whether they were from contamination or miscalling.

## ------------------ ##
## Filtering Criteria ##
## ------------------ ##

# MSK has the most samples analyzed with a matched normal control. So we can use it as a truth set
# that has minimal germline variants incorrectly called somatic. Let's use maf2maf v1.6.11 to
# annotate it with ExAC subpopulation allele counts and ClinVar annotations, among other things:
# ::NOTE:: The raw data file "data_mutations_extended_MSK.txt" cannot be made publicly available.
/opt/common/CentOS_6-dev/perl/perl-5.22.0/bin/perl /opt/common/CentOS_6-dev/vcf2maf/v1.6.11/maf2maf.pl --input-maf ../../data/mutations/data_mutations_extended_MSK.txt --output-maf bin/data_mutations_extended_msk.vep.maf --tmp-dir msk_anno --custom-enst /opt/common/CentOS_6-dev/vcf2maf/v1.6.11/data/isoform_overrides_uniprot --vep-path /opt/common/CentOS_6-dev/vep/v86 --vep-data /opt/common/CentOS_6-dev/vep/v86 --vep-forks 16 --filter-vcf /opt/common/CentOS_6-dev/vep/v86/ExAC_nonTCGA.r0.3.1.sites.vep.vcf.gz --max-filter-ac 16 --ref-fasta /opt/common/CentOS_6-dev/vep/v86/homo_sapiens/86_GRCh37/Homo_sapiens.GRCh37.75.dna.primary_assembly.fa.gz

# From MSK, we have a file (bin/msk_matched_normal_status.tsv) indicating which samples were
# "Matched" to normal controls. Use this to create a subset MAF of samples with matched controls:
perl -e '%m=map{split("\t")}`grep Matched bin/msk_matched_normal_status.tsv | cut -f2,3`; map{@c=split("\t"); print if($m{$c[15]} or $c[15] eq "Tumor_Sample_Barcode") }`cat bin/data_mutations_extended_msk.vep.maf`' > bin/data_mutations_extended_msk.matched.vep.maf

# ::NOTE:: Looks like 127 (2%) of 6457 MSK samples submitted to Genie, had no matched controls.

# Let's try different subpopulation allele count cutoffs till we get something that...
# 1. Removes no more than 1% (477/47725) of MSK's mutations from samples with matched controls:
perl -a -F'\t' -ne '$c=0; map{($ac)=m/^(\d+)/; ++$c if($ac>16)}@F[115..121]; print if($c>0)' bin/data_mutations_extended_msk.matched.vep.maf | wc -l
# 2. Manual review of most recurrent exclusions sites are unfamiliar, predicted benign, or common:
perl -a -F'\t' -ne '$c=0; map{($ac)=m/^(\d+)/; ++$c if($ac>16)}@F[115..121]; print if($c>0)' bin/data_mutations_extended_msk.matched.vep.maf | cut -f1,37,72,73,113,123 | sort | uniq -c | sort -rn | head -n15
# #Muts  Gene     HGVSp_Short       SIFT                              PolyPhen                  ExAC_AF_Adj  ExAC_FILTER
# 7      ASXL1    p.G646Wfs*12                                                                  0.0006317    PASS
# 6      AR       p.G473dup                                                                     0.007539     PASS
# 5      HNF1A    p.P291Qfs*51                                                                  0.001155     VQSRTrancheINDEL96.00to97.00
# 4      HLA-A    p.R30K            tolerated_low_confidence(0.05)    possibly_damaging(0.761)  0.0003905    PASS
# 4      DAXX     p.R526H           deleterious_low_confidence(0.04)  benign(0.007)             0.0003016    PASS
# 3      RPS6KA4  p.A287V           tolerated(0.34)                   benign(0.082)             0.00118      PASS
# 3      NOTCH2   p.A3F             tolerated_low_confidence(0.73)    unknown(0)                0.01489      PASS
# 3      NCOA3    p.Q1275_Q1276del                                                              0.007619     VQSRTrancheINDEL97.00to99.00
# 3      CDKN1A   p.R84Q            tolerated(0.59)                   benign(0.033)             0.002838     PASS
# 3      ASXL1    p.G645Vfs*58                                                                  0.001516     PASS
# 3      AR       p.L57del                                                                      0.002434     PASS
# 2      ROS1     p.E1902K          deleterious(0.03)                 possibly_damaging(0.509)  0.008532     PASS
# 2      RET      p.A373V           tolerated(0.35)                   benign(0.002)             0.0008199    PASS
# 2      RECQL4   p.V624I           tolerated(0.43)                   benign(0.064)             0.0002519    PASS
# 2      PTPRT    p.V396I           deleterious(0.01)                 benign(0.382)             0.001188     PASS

# Chose criteria: "At least one ExAC subpopulation has AC>16, and ClinVar doesn't say pathogenic".
# An AC>15 would have removed SF3B1:K700E. This criteria has already been implemented as the tag
# "common_variant" added by vcf2maf/maf2maf v1.6.11 under a column named FILTER.

# ::NOTE:: Tagged 356 calls across 238 MSK samples with matched controls. Median=1 call per sample.
# The most such calls per sample were: 20, 12, 8, 8, 7, 5, 5, 5, 4, 4, 4, 4, 4, 3, 3, ...

## ------------------- ##
## Check for known FPs ##
## ------------------- ##

# As part of the TCGA PancanAtlas MC3 project, Broad Institute (BI) ran their proprietary Panel of
# Normals (PoN) tool across 8000 TCGA normal exomes, in order to detect germline variant sites, or
# false-positives recurrent in exome-seq generated by the TCGA sequencing centers. Internally, BI
# stores the distribution of variant allele fractions (VAF) at these sites, so they can compare
# that to the VAF of candidate somatic variants. This helps retain true somatic variants at known
# germline positions, but unfortunately we don't have access to that level of detail. All we have
# is this list of variants per sample, that are tagged as failing their PoN filter in TCGA MC3:
# https://tcga-data-secure.nci.nih.gov/tcgafiles/tcgajamboree/tcgajamboree/mc3/broad/pancan.merged.v0.2.pfiltered.broad_pon_tagged_v2.txt.gz

# ::NOTE:: We don't have permission to use that file either, but we'll report some metrics here, to
# show what we're missing out on. Downloaded that file, formatted as tab-delim, removed sample IDs,
# de-duplicated by site+allele, and stored it locally at bin/tcga_pancan_broad_pon_fp_tags.tsv.gz

# Make a list of each Genie variant and their FILTER tags, and add Broad's PoN tag if seen above:
perl -a -F'\t' -ne 'BEGIN{%fp=map{chomp; ($_,1)}`gzip -dc bin/tcga_pancan_broad_pon_fp_tags.tsv.gz`} $k=join("\t",@F[4..6,10,12]); $F[108]=~s/^(\.|)$/PASS/; if($fp{$k}){$F[108].=",Broad_PoN"; $F[108]=~s/^PASS,//} print join("\t",$k,@F[2,108,15,0,36,50])."\n" unless(m/^#/)' ../../data/cbioportal/data_mutations_extended.txt > aacr_genie_filter_tags.tsv

# Summarize the FILTER tags:
cut -f7 aacr_genie_filter_tags.tsv | sort | uniq -c | sort -rn
# #Muts   FILTER
# 114038  PASS
#   3903  common_variant
#   1570  Broad_PoN
#   1019  common_variant,Broad_PoN

# For each center, count the number of FP calls tagged uniquely by Broad's PoN filter:
cut -f6,7 aacr_genie_filter_tags.tsv | sort | uniq -c | grep -Ev "common|PASS" | sort -rn
# #Muts  Center  FILTER     %Muts
# 806    MSK     Broad_PoN  1.71%
# 619    DFCI    Broad_PoN  1.20%
#  69    JHH     Broad_PoN  0.96%
#  36    VICC    Broad_PoN  0.39%
#  23    UHN     Broad_PoN  1.06%
#   8    MDA     Broad_PoN  0.63%
#   7    NKI     Broad_PoN  0.82%
#   2    GRCC    Broad_PoN  0.24%

# Do the same thing, but count the unique FP sites tagged (de-duplicate position+allele):
cut -f1-7 aacr_genie_filter_tags.tsv | sort -u | cut -f6,7 | grep -Ev "common|PASS" | sort | uniq -c | sort -rn
# #Sites Center  FILTER     %Sites
# 397    MSK     Broad_PoN  1.09%
# 329    DFCI    Broad_PoN  0.82%
#  29    VICC    Broad_PoN  0.39%
#  13    JHH     Broad_PoN  0.71%
#  11    UHN     Broad_PoN  0.96%
#   3    NKI     Broad_PoN  0.66%
#   2    MDA     Broad_PoN  0.40%
#   2    GRCC    Broad_PoN  0.32%

# List out the top few recurrent sites tagged tagged uniquely by Broad's PoN filter:
grep -Ev "common|PASS" aacr_genie_filter_tags.tsv | cut -f1-5,9- | sort | uniq -c | sort -rn | head -n15
# #Muts  Chr  Start      End        Ref    Alt  Gene    HGVSp_Short    Consequence
# 53     5    112175212  112175216  AAAAG  -    APC     p.E1309Dfs*4   frameshift_variant
# 36     12   112926854  112926854  A      -    PTPN11  p.T493Pfs*57   frameshift_variant
# 30     17   56435161   56435161   C      -    RNF43   p.G659Vfs*41   frameshift_variant
# 22     1    27105930   27105931   -      G    ARID1A  p.D1850Gfs*4   frameshift_variant
# 19     1    27105931   27105931   G      -    ARID1A  p.D1850Tfs*33  frameshift_variant
# 19     10   89720811   89720812   -      A    PTEN    p.N323Kfs*2    frameshift_variant
# 17     X    66765161   66765161   A      T    AR      p.Q58L         missense_variant
# 14     X    129190011  129190011  C      -    BCORL1  p.P1681Qfs*20  frameshift_variant
# 14     17   7579471    7579471    G      -    TP53    p.V73Wfs*50    frameshift_variant
# 14     16   67645338   67645339   -      A    CTCF    p.T204Nfs*26   frameshift_variant
# 14     10   114925317  114925317  A      -    TCF7L2  p.K485Sfs*23   frameshift_variant
# 13     7    2968323    2968323    G      -    CARD11  p.R555Gfs*45   frameshift_variant
# 13     17   7579470    7579471    -      G    TP53    p.V73Rfs*76    frameshift_variant
# 13     17   29553477   29553478   -      C    NF1     p.I679Dfs*21   frameshift_variant
# 13     1    65306997   65306997   T      -    JAK1    p.K860Nfs*16   frameshift_variant
